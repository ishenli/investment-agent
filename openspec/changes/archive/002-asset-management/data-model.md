# 数据模型：资产管理

## 实体

### 交易账户

代表用户的虚拟交易账户。

**字段：**

- `id` (string, 必填): 交易账户的唯一标识符
- `userId` (string, 必填): 关联的用户账户ID
- `accountName` (string, 可选): 用户自定义的账户名称
- `balance` (number, 必填): 当前虚拟余额
- `currency` (string, 必填): 货币代码 (默认: "USD")
- `leverage` (number, 必填): 杠杆设置 (默认: 1)
- `market` (string, 必填): 选择的市场 ("A股" | "美股")
- `createdAt` (Date, 必填): 账户创建时间戳
- `updatedAt` (Date, 必填): 账户最后更新时间戳
- `isActive` (boolean, 必填): 账户是否激活

**验证规则：**

- 余额必须非负
- 杠杆必须在1到100之间
- 市场必须是允许的值之一

### 交易记录

代表交易账户中的单笔交易。

**字段：**

- `id` (string, 必填): 交易的唯一标识符
- `accountId` (string, 必填): 关联的交易账户ID
- `type` (string, 必填): 交易类型 ("deposit" | "withdrawal" | "trade")
- `amount` (number, 必填): 交易金额 (存款为正，取款为负)
- `balanceAfter` (number, 必填): 交易后账户余额
- `description` (string, 可选): 交易描述
- `referenceId` (string, 可选): 关联实体引用 (例如: 交易ID)
- `createdAt` (Date, 必填): 交易发生的时间戳

**验证规则：**

- 金额不能为零
- 交易后余额必须非负
- 类型必须是允许的值之一

### 持仓

代表交易账户中的当前持仓。

**字段：**

- `id` (string, 必填): 持仓的唯一标识符
- `accountId` (string, 必填): 关联的交易账户ID
- `symbol` (string, 必填): 股票代码
- `quantity` (number, 必填): 股份数量
- `averageCost` (number, 必填): 平均成本价
- `currentPrice` (number, 必填): 当前市场价格
- `marketValue` (number, 必填): 当前市值 (数量 \* 当前价格)
- `unrealizedPnL` (number, 必填): 未实现盈亏
- `createdAt` (Date, 必填): 持仓开仓时间戳
- `updatedAt` (Date, 必填): 持仓最后更新时间戳

**验证规则：**

- 数量必须为正数
- 平均成本必须为正数
- 当前价格必须为正数

### 业绩指标

代表交易账户的业绩指标。

**字段：**

- `id` (string, 必填): 指标记录的唯一标识符
- `accountId` (string, 必填): 关联的交易账户ID
- `periodStart` (Date, 必填): 业绩周期开始时间
- `periodEnd` (Date, 必填): 业绩周期结束时间
- `totalReturn` (number, 必填): 总收益率百分比
- `annualizedReturn` (number, 必填): 年化收益率百分比
- `volatility` (number, 必填): 波动率百分比
- `sharpeRatio` (number, 必填): 夏普比率
- `maxDrawdown` (number, 必填): 最大回撤百分比
- `winRate` (number, 必填): 胜率百分比
- `totalTrades` (number, 必填): 总交易次数
- `profitableTrades` (number, 必填): 盈利交易次数
- `createdAt` (Date, 必填): 指标计算时间戳

**验证规则：**

- 周期结束时间必须晚于开始时间
- 总交易次数必须为正数
- 胜率必须在0到100之间

## 关系

1. **用户账户** → **交易账户** (1:N)
   - 一个用户账户可以拥有多个交易账户
   - 每个交易账户只属于一个用户账户

2. **交易账户** → **交易记录** (1:N)
   - 一个交易账户可以有多条交易记录
   - 每条交易记录只属于一个交易账户

3. **交易账户** → **持仓** (1:N)
   - 一个交易账户可以有多个持仓
   - 每个持仓只属于一个交易账户

4. **交易账户** → **业绩指标** (1:N)
   - 一个交易账户可以有多个业绩指标(不同时期)
   - 每个业绩指标只属于一个交易账户

## 状态转换

### 交易账户状态

- `active` → `inactive`: 账户被用户或系统停用
- `inactive` → `active`: 账户被用户重新激活

### 持仓状态

- `open` → `closed`: 持仓被完全卖出
- `open` → `partial`: 持仓被部分卖出 (初始版本未实现)

## 数据流

1. **账户创建**:
   - 用户通过账户管理模块创建基础账户
   - 用户在此模块创建交易账户并初始化资金
   - 系统创建交易账户和初始存款记录

2. **交易活动**:
   - 用户执行交易操作
   - 系统更新持仓信息
   - 系统创建交易记录
   - 系统更新账户余额

3. **业绩计算**:
   - 系统定期计算业绩指标
   - 系统存储业绩指标

## 业绩计算逻辑

### 总收益率计算

```
总收益率 = (期末账户总价值 - 期初账户总价值) / 期初账户总价值 × 100%
```

其中账户总价值 = 现金余额 + 持仓市值

### 年化收益率计算

```
年化收益率 = (1 + 总收益率)^(365 / 投资天数) - 1
```

### 波动率计算

1. 计算每日收益率序列
2. 计算收益率的标准差
3. 年化波动率 = 日波动率 × √252

### 夏普比率计算

```
夏普比率 = (年化收益率 - 无风险利率) / 年化波动率
```

默认无风险利率为2%

### 最大回撤计算

1. 计算每日累计净值曲线
2. 对每个日期，计算从之前峰值到当前值的最大跌幅
3. 取所有跌幅中的最大值作为最大回撤

### 胜率计算

```
胜率 = 盈利交易次数 / 总交易次数 × 100%
```
